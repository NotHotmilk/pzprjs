/*! @license pzpr.js v1375cc80 (c) 2009-2025 sabo2, MIT license
 *   https://github.com/sabo2/pzprv3 */
!function(e,t){"object"==typeof module&&module.exports?module.exports=[e,t]:pzpr.classmgr.makeCustom(e,t)}(["pencils"],{MouseEvent:{inputModes:{edit:["arrow","number","undef","clear"],play:["border","line","arrow","peke","bgcolor","bgcolor1","bgcolor2"]},mouseinput_number:function(){this.mousestart&&this.inputqnum()},mouseinput:function(){"undef"===this.inputMode?this.mousestart&&this.inputqnum():this.common.mouseinput.call(this)},mouseinput_auto:function(){this.mousestart&&this.isBorderMode(),this.puzzle.playmode?this.mousestart||this.mousemove?"left"===this.btn?this.isBorderMode()?this.inputborder():this.inputLineOrArrow():this.inputpeke():this.mouseend&&this.notInputted()&&(this.isBorderMode()?this.inputArrow():this.inputBGcolor()):this.puzzle.editmode&&this.mouseend&&(this.isBorderMode()?this.inputArrow():this.inputqnum_pencils())},inputArrow:function(){var e=this.getpos(.22).getb();if(e.inside){var t=e.sidecell[0],i=e.sidecell[1],r=-1!==t.qnum&&this.puzzle.playmode,n=e.getArrow(),s=0,c=0;if(e.isvert)switch(n){case 0:if(!r){s=t.LT,c=0;break}case t.LT:s=0,c=t.RT;break;default:c=s=0}else switch(n){case 0:if(!r){s=t.UP,c=0;break}case t.UP:s=0,c=t.DN;break;default:c=s=0}t.setArrow(s,this.puzzle.editmode),i.setArrow(c,this.puzzle.editmode),t.draw(),i.draw(),e.draw()}},inputLineOrArrow:function(){var e,t,i,r=this.getpos(0);this.prevPos.equals(r)||(t=(e=this.prevPos.getnb(r)).sidecell[0],i=e.sidecell[1],e.isnull||(null===this.inputData&&(!e.isvert||t.qans!==e.LT&&i.qans!==e.RT||(t.qans===e.LT&&t.setQans(0),i.qans===e.RT&&i.setQans(0),this.inputData=0),e.isvert||t.qans!==e.UP&&i.qans!==e.DN||(t.qans===e.UP&&t.setQans(0),i.qans===e.DN&&i.setQans(0),this.inputData=0)),null===this.inputData&&(this.inputData=e.isLine()?0:1),1!==this.inputData||e.ques?0===this.inputData&&e.removeLine():1===e.qans?0<this.getDrawArrowDirection(e)?i.setArrow(e.isvert?e.RT:e.DN,!1):t.setArrow(e.isvert?e.LT:e.UP,!1):e.setLine(),e.draw()),this.prevPos=r)},getDrawArrowDirection:function(e){if(e.sidecell[0].isnull)return 1;if(e.sidecell[1].isnull)return-1;if(0<e.sidecell[0].qnum)return 1;if(0<e.sidecell[1].qnum)return-1;if(0<e.sidecell[1].lcnt&&0===e.sidecell[0].lcnt)return 1;if(0<e.sidecell[0].lcnt&&0===e.sidecell[1].lcnt)return-1;if(e.sidecell[0].room.pencil)return 1;if(e.sidecell[1].room.pencil)return-1;var t=this.getpos(0),t=this.prevPos.getdir(t,2);return t===e.RT||t===e.DN?1:-1},mouseinput_clear:function(){var e=this.getcell();e.getPencilDir()?e.setArrow(0,!0):this.inputclean_cell()},inputarrow_cell_main:function(e,t){e.setArrow(t,this.puzzle.editmode)},inputqnum_pencils:function(){var e=this.getcell();e.isnull||(e!==this.cursor.getc()&&"auto"===this.inputMode?this.setcursor(e):this.inputqnum(e))}},KeyEvent:{enablemake:!0,moveTarget:function(e){return!e.match(/shift/)&&this.moveTCell(e)},keyinput:function(e){var t=this.cursor.getc();if(!t.isnull){var i=0;switch(e){case"shift+up":i=t.UP;break;case"shift+down":i=t.DN;break;case"shift+left":i=t.LT;break;case"shift+right":i=t.RT}0!==i?(t.setArrow(i,!0),this.cursor.draw()):this.key_inputqnum_pencils(e)}},key_inputqnum_pencils:function(e){var t=this.cursor.getc();"q"===e||"-"===e?-2!==t.qnum?(t.setArrow(0,!0),t.setQnum(-2)):(t.setArrow(0,!0),t.setQnum(-1)):" "===e||"BS"===e?(t.setArrow(0,!0),t.setQnum(-1)):(this.key_inputqnum_main(t,e),t.isNum()&&t.setArrow(0,!0)),(this.prev=t).draw()}},Cell:{maxnum:function(){var e=this.board;return Math.max(e.cols,e.rows)-1},minnum:1,setArrow:function(e,t){var i,r,n;0<=e&&e<=4&&((i={})[this.UP]={inv:this.DN,border:this.adjborder.bottom,cell:this.adjacent.bottom},i[this.DN]={inv:this.UP,border:this.adjborder.top,cell:this.adjacent.top},i[this.LT]={inv:this.RT,border:this.adjborder.right,cell:this.adjacent.right},i[this.RT]={inv:this.LT,border:this.adjborder.left,cell:this.adjacent.left},r=this.qans,n=this.qdir,this.setQans(0),0<r&&i[r].cell.qans!==i[r].inv&&i[r].border.setQans(0),t?(1<=n&&n<=4&&i[n].cell.qdir!==i[n].inv&&i[n].border.setQues(0),(e=n===e?0:e)&&this.setQnum(-1),0<e&&!i[e].border.isnull&&i[e].border.setQues(1),this.setQdir(e)):1<=n&&n<=4||-1!==this.qnum||(0<(e=r===e?0:e)&&!i[e].border.isnull&&i[e].border.setQans(1),this.setQans(e)))},getPencilDir:function(){var e=this.qdir;if(1<=e&&e<=4)return e;e=this.qans;return 1<=e&&e<=4?e:0},isStart:function(e){var t=this.room.clist.getRectSize();if(1<t.cols&&1<t.rows)return!1;switch(e){case this.LT:return 1===t.rows&&this.bx===t.x1&&this.by===t.y1;case this.RT:return 1===t.rows&&this.bx===t.x2&&this.by===t.y1;case this.UP:return 1===t.cols&&this.bx===t.x1&&this.by===t.y1;case this.DN:return 1===t.cols&&this.bx===t.x1&&this.by===t.y2}return!1},getPencilStart:function(){var e=this.getPencilDir();return e===this.UP?this.adjacent.bottom:e===this.DN?this.adjacent.top:e===this.LT?this.adjacent.right:e===this.RT?this.adjacent.left:this.board.emptycell},isTip:function(){return 0<this.getPencilDir()},isTipOfPencil:function(){var e=this.getPencilDir(),t=this.getPencilStart();return!t.isnull&&t.isStart(e)},getPencilSize:function(){return this.isTipOfPencil()?this.getPencilStart().room.clist.length:0},insidePencil:function(){return this.room.isPencil()}},GraphComponent:{getPotentialTips:function(){var e=this.clist.getRectSize();if(1<e.cols&&1<e.rows)return[];var t,i=[];return 1===e.rows&&(t=this.board.getc(e.x1,e.y1),i.push({dir:t.LT,start:t,tip:t.adjacent.left}),t=this.board.getc(e.x2,e.y1),i.push({dir:t.RT,start:t,tip:t.adjacent.right})),1===e.cols&&(t=this.board.getc(e.x1,e.y1),i.push({dir:t.UP,start:t,tip:t.adjacent.top}),t=this.board.getc(e.x1,e.y2),i.push({dir:t.DN,start:t,tip:t.adjacent.bottom})),i},getTips:function(){for(var e=this.getPotentialTips(),t=[],i=0;i<e.length;i++){var r=e[i];r.tip.getPencilDir()===r.dir&&t.push(r.tip)}return t},isPencil:function(){return 0<this.getTips().length},seterr:function(t){this.clist.each(function(e){t>e.error&&(e.error=t)})}},Board:{hasborder:1},Border:{getArrow:function(){var e=this.sidecell[0],t=this.sidecell[1];if(this.isvert){if(e.getPencilDir()===e.LT)return e.LT;if(t.getPencilDir()===t.RT)return t.RT}else{if(e.getPencilDir()===e.UP)return e.UP;if(t.getPencilDir()===t.DN)return t.DN}return 0},prehook:{qans:function(e){return 0!==this.ques||!e&&0!==this.getArrow()}}},BoardExec:{adjustBoardData:function(e,t){for(var i=this.getTranslateDir(e),r=this.board.cellinside(t.x1,t.y1,t.x2,t.y2),n=0;n<r.length;n++){var s=r[n],c=i[s.qdir];c&&(s.qdir=c),(c=i[s.qans])&&(s.qans=c)}}},AreaRoomGraph:{enabled:!0},LineGraph:{enabled:!0,makeClist:!0},Graphic:{gridcolor_type:"DLIGHT",linecolor:"rgb(80, 80, 80)",paint:function(){this.drawBGCells(),this.drawDashedGrid(),this.drawBorders(),this.drawLines(),this.drawCellArrows(),this.drawQuesNumbers(),this.drawPekes(),this.drawChassis(),this.drawTarget()},getQuesNumberColor:function(e){return 2===e.error?this.errcolor1:1===e.error?this.quescolor:this.getQuesNumberColor_qnum(e)},getBGCellColor:function(e){return 2===e.error?this.errbcolor1:this.getBGCellColor_qsub2(e)},getBorderColor:function(e){return 1===e.ques?this.quescolor:1===e.qans?e.error?"red":e.trial?this.trialcolor:this.qanscolor:null},drawCellArrows:function(){for(var e=this.vinc("cell_arrow","crispEdges"),t=.5*this.cw,i=.25*this.cw,r=this.range.cells,n=0;n<r.length;n++){var s=r[n],c=s.getPencilDir(),o=this.getCellArrowColor(s);if(e.lineWidth=(this.lw+this.addlw)/2,o){e.fillStyle=o,e.strokeStyle=o;var o=s.bx*this.bw,l=s.by*this.bh,h=[0,0,0,0];switch(c){case s.UP:h=[1,1,-1,1];break;case s.DN:h=[1,-1,-1,-1];break;case s.LT:h=[1,-1,1,1];break;case s.RT:h=[-1,-1,-1,1]}e.vid="c_arrow_"+s.id,e.setOffsetLinePath(o,l,0,0,h[0]*i,h[1]*i,h[2]*i,h[3]*i,!0),e.fill(),e.vid="c_arrow_outer_"+s.id,e.setOffsetLinePath(o,l,0,0,h[0]*t,h[1]*t,h[2]*t,h[3]*t,!0),e.stroke()}else e.vid="c_arrow_"+s.id,e.vhide(),e.vid="c_arrow_outer_"+s.id,e.vhide()}},getCellArrowColor:function(e){return e.getPencilDir()?e.qdir?this.quescolor:e.trial?this.trialcolor:this.qanscolor:null}},Encode:{decodePzpr:function(e){for(var t=0,i=0,r=this.outbstr,n=this.board,i=0;i<r.length;i++){var s=r.charAt(i),c=n.cell[t];if(this.include(s,"0","9")||this.include(s,"a","f")?c.qnum=parseInt(s,16):"-"===s?(c.qnum=parseInt(r.substr(i+1,2),16),i+=2):"."===s?c.qnum=-2:"g"<=s&&s<="j"?c.setArrow(parseInt(s,20)-15,!0):"k"<=s&&s<="z"&&(t+=parseInt(s,36)-20),t++,!n.cell[t])break}this.outbstr=r.substr(i+1)},encodePzpr:function(e){for(var t="",i=0,r=this.board,n=0;n<r.cell.length;n++){var s="",c=r.cell[n].qdir,o=r.cell[n].qnum;-1!==o?s=0<=o&&o<16?o.toString(16):16<=o&&o<256?"-"+o.toString(16):".":0!==c?s=(c+15).toString(20):i++,0===i?t+=s:!s&&16!==i||(t+=(i+19).toString(36)+s,i=0)}0<i&&(t+=(i+19).toString(36)),this.outbstr+=t}},FileIO:{decodeData:function(){this.decodeCell(function(e,t){"o"===t.charAt(0)?(e.qdir=5,1<t.length&&(e.qnum=+t.substr(1))):"."!==t&&e.setArrow(+t,!0)}),this.decodeBorderAns(),this.decodeBorderLine(),this.decodeCell(function(e,t){"+"===t.charAt(0)?(e.qsub=1,t=t.substr(1)):"-"===t.charAt(0)&&(e.qsub=2,t=t.substr(1)),"."!==t&&+t<=4&&(e.qans=+t)})},encodeData:function(){this.encodeCell(function(e){return-1!==e.qnum?"o"+(-1!==e.qnum?e.qnum:"")+" ":0!==e.qdir?e.qdir+" ":". "}),this.encodeBorderAns(),this.encodeBorderLine(),this.encodeCell(function(e){var t="";return 1===e.qsub?t+="+":2===e.qsub&&(t+="-"),0!==e.qans&&(t+=e.qans.toString()),(t=""===t?".":t)+" "})}},AnsCheck:{checklist:["checkBranchLine","checkCrossLine","checkOneTip","checkLineSingleTip","checkLineTooLong","checkNumberTooHigh","checkTipNotInsidePencil","checkLineOutsidePencil","checkNumberInPencil","checkTipHasLine","checkLineHasTip","checkNumberTooLow","checkLineTooShort","checkTipHasPencil","checkCellsUsed"],checkTipHasPencil:function(){this.checkAllCell(function(e){return e.isTip()&&!e.isTipOfPencil()},"ptNoPencil")},checkTipNotInsidePencil:function(){this.checkAllCell(function(e){return e.isTip()&&e.insidePencil()},"ptInPencil")},checkOneTip:function(){for(var e=this.board.roommgr.components,t=0;t<e.length;t++){var i=e[t].getTips();if(1<i.length){if(this.failcode.add("pcMultipleTips"),this.checkOnly)return;i.forEach(function(e){e.seterr(1)}),e[t].clist.seterr(1)}}},checkNumberTooLow:function(){this.pencils_checkPencilSize(-1,"nmSizeLt")},checkNumberTooHigh:function(){this.pencils_checkPencilSize(1,"nmSizeGt")},pencils_checkPencilSize:function(e,t){for(var i=this.board.roommgr.components,r=0;r<i.length;r++){var n=i[r];if(n.isPencil())for(var s=n.clist.length,c=0;c<n.clist.length;c++){var o=n.clist[c],l=o.qnum;if(0<l&&(e<0&&l<s||0<e&&s<l)){if(this.failcode.add(t),this.checkOnly)return;o.seterr(2),n.seterr(1)}}}},checkNumberInPencil:function(){this.checkAllCell(function(e){return(-2===e.qnum||0<e.qnum)&&!e.insidePencil()},"nmOutsidePencil")},checkLineOutsidePencil:function(){this.checkAllCell(function(e){return 0<e.lcnt&&e.insidePencil()},"lnCrossPencil")},checkTipHasLine:function(){this.checkAllCell(function(e){return e.isTip()&&1!==e.lcnt},"ptNoLine")},pencils_checkLines:function(e,t){for(var i=this.board.linegraph.components,r=0;r<i.length;r++){var n=i[r],s=n.clist.filter(function(e){return e.isTip()&&1===e.lcnt});if(e(s)){if(this.failcode.add(t),this.checkOnly)return;s.each(function(e){e.seterr(1)}),n.setedgeerr(1)}}},checkLineHasTip:function(){this.pencils_checkLines(function(e){return e.length<1},"lnNoTip")},checkLineSingleTip:function(){this.pencils_checkLines(function(e){return 1<e.length},"lnMultipleTips")},checkLineTooShort:function(){this.pencils_checkLineLength(-1,"lnLengthLt")},checkLineTooLong:function(){this.pencils_checkLineLength(1,"lnLengthGt")},pencils_checkLineLength:function(e,t){for(var i=this.board.cell,r=0;r<i.length;r++){var n=i[r];if(n.isTip()&&1===n.lcnt){var s=n.path.nodes.length-1,c=n.getPencilSize();if(0<c&&(e<0&&s<c||0<e&&c<s)){if(this.failcode.add(t),this.checkOnly)return;n.getPencilStart().room.seterr(1),n.path.setedgeerr(1)}}}},checkCellsUsed:function(){this.checkAllCell(function(e){return 0===e.lcnt&&!e.insidePencil()},"unusedCell")}}});