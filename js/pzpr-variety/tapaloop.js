/*! @license pzpr.js v1375cc80 (c) 2009-2025 sabo2, MIT license
 *   https://github.com/sabo2/pzprv3 */
!function(e,t){"object"==typeof module&&module.exports?module.exports=[e,t]:pzpr.classmgr.makeCustom(e,t)}(["tapaloop","disloop"],{MouseEvent:{inputModes:{edit:[],play:["line","peke","subcircle","subcross","info-line"]},mouseinput_auto:function(){this.puzzle.playmode?"left"===this.btn?this.mousestart||this.mousemove?this.inputLine():this.mouseend&&this.notInputted()&&(this.inputpeke_ifborder()||this.inputMB()):"right"===this.btn&&(this.mousestart||this.mousemove?this.inputpeke():this.mouseend&&this.notInputted()&&(this.inputpeke_ifborder()||this.inputMB())):this.puzzle.editmode&&this.mousestart&&this.setcursor(this.getcell())}},"MouseEvent@disloop":{inputModes:{edit:["arrow","clear"],play:["line","peke","info-line"]},mouseinput_auto:function(){this.puzzle.playmode?"left"===this.btn?this.mousestart||this.mousemove?this.inputLine():this.mouseend&&this.notInputted()&&this.inputpeke_ifborder():"right"===this.btn&&(this.mousestart||this.mousemove?this.inputpeke():this.mouseend&&this.notInputted()&&this.inputpeke_ifborder()):this.puzzle.editmode&&(this.mousestart&&this.setcursor(this.getcell()),this.inputarrow_cell())},inputarrow_cell_main:function(e,t){e.setQdir(e.qdir===t?0:t)}},KeyEvent:{enablemake:!0,keyinput:function(e){this.key_inputqnums(e)}},"KeyEvent@disloop":{enablemake:!0,keyinput:function(e){var t=this.cursor.getc(),i=t.qnums;if(" "===e||"BS"===e&&1===i.length){if(-2===i[0])return t.setQnums([]),t.setQdir(0),void t.draw();if(0!==t.qdir)return t.setQnums([-2]),t.draw(),void(this.prev=null)}this.key_inputarrow(e)||this.key_inputqnums(e)}},Cell:{noLP:function(e){return 0!==this.qnums.length}},"Cell@tapaloop":{minnum:0,maxnum:8,isValidQnums:function(e){for(var t=0,i=0;i<e.length;i++){if(0===e[i])return!1;t+=0<=e[i]?e[i]:1}return t<=8},getSegmentLengths:function(){for(var e=[],t=0,i=[[-2,-2],[0,-2],[2,-2],[2,0],[2,2],[0,2],[-2,2],[-2,0]],r=[[-1,-2],[1,-2],[2,-1],[2,1],[1,2],[-1,2],[-2,1],[-2,-1]],n=0;n<8;n++){if(0===t){var o=this.relcell(i[n][0],i[n][1]);if(!(o&&0<o.lcnt))continue;t=1}o=this.relbd(r[n][0],r[n][1]);o&&o.isLine()?t++:(e.push(t),t=0)}return 0<t&&e.push(t),0===e.length?e.push(0):this.relbd(-2,-1).isLine()&&(e[0]+=e[e.length-1]-1,e.pop()),e}},"Cell@disloop":{maxnum:9,posthook:{qdir:function(e){0===this.qnums.length&&0!==e&&this.setQnums([-2])}},getSegmentLengths:function(){if(0===this.qdir||0===this.qnums.length)return[];var e=this.qdir,t=this.getaddr();if(t.movedir(e,3),!t.getb().line)return[];for(var i=[new this.klass.BorderList];i.length<=this.qnums.length&&(i[0].add(t.getb()),t.movedir(e,1),2===t.getc().lcnt);){for(var r=1;r<=4;r++)if(r!=={1:2,2:1,3:4,4:3}[e]){var n=t.getaddr();if(n.movedir(r,1),n.getb().line){r!==e&&(i.unshift(new this.klass.BorderList),e=r);break}}t.movedir(e,1)}return i.slice(-this.qnums.length).reverse()}},Border:{enableLineNG:!0,isBorder:function(){return this.sidecell[0].noLP()||this.sidecell[1].noLP()}},Board:{hasborder:1},"BoardExec@disloop":{adjustBoardData:function(e,t){this.adjustNumberArrow(e,t)}},LineGraph:{enabled:!0},"BorderList@disloop":{seterr:function(e){if(this.board.isenableSetError())for(var t=0;t<this.length;t++){var i=this[t].error;this[t].error=i<=0?e:Math.max(i,e)}}},Graphic:{irowake:!0,gridcolor_type:"SLIGHT",paint:function(){this.drawBGCells(),this.drawGrid(),this.drawTapaNumbers(),"disloop"===this.pid&&(this.drawCellArrows(),this.drawBorders()),this.drawMBs(),this.drawPekes(),this.drawLines(),this.drawChassis(),this.drawTarget()}},"Graphic@disloop":{getLineColor:function(e){var t=this.common.getLineColor.call(this,e),i=e.error||e.qinfo;return e.isLine()&&3===i?t=this.errlinecolor:e.isLine()&&2===i&&(t="rgb(100,0,0)"),t},getQuesNumberColor:function(e){return 1===e.qnums.length&&-2===e.qnums[0]&&0===e.qdir?null:this.getQuesNumberColor_mixed(e)},getBGCellColor:function(e){return e.noLP()?"rgb(224,224,224)":this.getBGCellColor_error1(e)},getCellArrowColor:function(e){return 1<=e.qdir&&e.qdir<=4?e.error?this.errcolor1:this.quescolor:null},drawCellArrows:function(){for(var e=this.vinc("cell_arrow","auto"),t=.5*this.cw,i=this.range.cells,r=0;r<i.length;r++){var n=i[r],o=n.qdir,s=this.getCellArrowColor(n);if(e.lineWidth=(this.lw+this.addlw)/2,s){e.fillStyle=s,e.strokeStyle=s;var l=n.bx*this.bw,u=n.by*this.bh,h=[0,0,0,0];switch(o){case n.UP:h=[.5,.75,-.5,.75],u-=1.75*this.bh;break;case n.DN:h=[.5,-.75,-.5,-.75],u+=1.75*this.bh;break;case n.LT:h=[.75,-.5,.75,.5],l-=1.75*this.bw;break;case n.RT:h=[-.75,-.5,-.75,.5],l+=1.75*this.bw}e.vid="c_arrow_"+n.id,e.setOffsetLinePath(l,u,0,0,h[0]*t,h[1]*t,h[2]*t,h[3]*t,!0),e.fill()}else e.vid="c_arrow_"+n.id,e.vhide()}}},"Encode@tapaloop":{decodePzpr:function(e){this.decodeNumber_tapaloop()},encodePzpr:function(e){this.encodeNumber_tapaloop()},decodeNumber_tapaloop:function(){for(var e=0,t=0,i=this.outbstr,r=this.board,t=0;t<i.length;t++){var n=r.cell[e],o=i.charAt(t);if(this.include(o,"0","8"))n.qnums=[parseInt(o,10)];else if("."===o)n.qnums=[-2];else if(this.include(o,"a","f")){var s=[];360<=(u=parseInt(i.substr(t,2),36))&&((s=[0,0])[0]=(u-=360)/8|0,u-=8*s[0],s[1]=u);for(var l=0;l<4;l++)0===s[l]&&(s[l]=-2);n.qnums=s,t++}else if("+"===o){var u=parseInt(i.substr(t+1,2),36)-36;(s=[0,0,0])[0]=u/49|0,u-=49*s[0],s[1]=u/7|0,u-=7*s[1],s[2]=u;for(l=0;l<4;l++)0===s[l]&&(s[l]=-2);n.qnums=s,t+=2}else if("-"===o){u=parseInt(i.substr(t+1,2),36)-36;(s=[0,0,0,0])[0]=u/216|0,u-=216*s[0],s[1]=u/36|0,u-=36*s[1],s[2]=u/6|0,u-=6*s[2],s[3]=u;for(l=0;l<4;l++)0===s[l]&&(s[l]=-2);n.qnums=s,t+=2}else"g"<=o&&o<="z"&&(e+=parseInt(o,36)-16);if(e++,!r.cell[e])break}this.outbstr=i.substr(t+1)},encodeNumber_tapaloop:function(){for(var e=0,t="",i=this.board,r=0;r<i.cell.length;r++){var n="",o=i.cell[r].qnums;1===o.length?n=-2===o[0]?".":o[0].toString(10):2===o.length?n=(8*(0<o[0]?o[0]:0)+(0<o[1]?o[1]:0)+360).toString(36):3===o.length?n="+"+(49*(0<o[0]?o[0]:0)+7*(0<o[1]?o[1]:0)+(0<o[2]?o[2]:0)+36).toString(36):4===o.length?n="-"+(216*(0<o[0]?o[0]:0)+36*(0<o[1]?o[1]:0)+6*(0<o[2]?o[2]:0)+(0<o[3]?o[3]:0)+36).toString(36):e++,0===e?t+=n:!n&&20!==e||(t+=(15+e).toString(36)+n,e=0)}0<e&&(t+=(15+e).toString(36)),this.outbstr+=t}},"Encode@disloop":{decodePzpr:function(e){this.decodeArrowNumber_disloop(),this.puzzle.setConfig("loop_full",this.checkpflag("f"))},encodePzpr:function(e){this.outpflag=this.puzzle.getConfig("loop_full")?"f":null,this.encodeArrowNumber_disloop()},decodeArrowNumber_disloop:function(){var r=this.board;this.genericDecodeNumber16(r.cell.length,function(e,t){if(r.cell[e].qdir=0,-1===t)r.cell[e].qnums=[];else if(t){for(var i=[];0<t;)i.unshift(t%10||-2),t=t/10|0;r.cell[e].qdir=i[0],r.cell[e].qnums=i.slice(1)}else r.cell[e].qnums=[-2]})},encodeArrowNumber_disloop:function(){var n=this.board;this.genericEncodeNumber16(n.cell.length,function(e){var t=n.cell[e];if(0===t.qnums.length)return-1;if(0===t.qdir)return 0;for(var i=t.qdir,r=0;r<t.qnums.length;r++)i*=10,0<t.qnums[r]&&(i+=t.qnums[r]);return i})}},FileIO:{decodeData:function(){this.decodeQnums(),this.decodeBorderLine(),this.decodeCellQsub()},encodeData:function(){this.encodeQnums(),this.encodeBorderLine(),this.encodeCellQsub()}},"FileIO@disloop":{decodeData:function(){this.decodeConfigFlag("f","loop_full"),this.decodeQnums(),this.decodeDirs(),this.decodeBorderLine()},encodeData:function(){this.encodeConfigFlag("f","loop_full"),this.encodeQnums(),this.encodeDirs(),this.encodeBorderLine()},decodeDirs:function(){this.decodeCell(function(e,t){e.qdir=+t||0})},encodeDirs:function(){this.encodeCell(function(e){return e.qdir+" "})}},AnsCheck:{checklist:["checkBranchLine","checkCrossLine","checkTapaloop","checkArrowLineExist@disloop","checkNumberHasArrow@disloop","checkDeadendLine+","checkNoLineIfVariant@disloop","checkOneLoop"],checkTapaloop:function(){var s=this.pid,l=this.board.border;this.checkAllCell(function(e){if(0===e.qnums.length)return!1;var t=e.getSegmentLengths();if("disloop"!==s&&e.qnums.length!==t.length)return!0;for(var i=e.qnums.slice(),r=-1,n=0;n<t.length;n++){var o="number"==typeof t[n]?t[n]:t[n].length,o=i.indexOf(o);(o=o<0?i.indexOf(-2):o)<0&&("object"==typeof t[n]&&(l.setnoerr(),t[n].seterr(3)),r=n),i.splice(o,1)}if(-1!==r)for(n=0;n<r;n++)"object"==typeof t[n]&&t[n].seterr(2);return 0<=r},"tapaloopError")}},"AnsCheck@disloop":{checkNoLine:function(){this.checkAllCell(function(e){return 0===e.lcnt&&!e.noLP()},"ceNoLine")},checkArrowLineExist:function(){this.checkAllCell(function(e){if(0===e.qdir)return!1;var t=e.getaddr();return t.movedir(e.qdir,3),t.getb().line?void 0:(t.movedir(e.qdir,-1),t.getc().seterr(1),!0)},"anLineLt")},checkNumberHasArrow:function(){this.checkAllCell(function(e){return(1!==e.qnums.length||-2!==e.qnums[0])&&(0<e.qnums.length&&e.qdir===e.NDIR)},"anNoArrow")}}});